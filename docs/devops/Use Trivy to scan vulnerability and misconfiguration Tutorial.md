# Trivy

### Installation

```
brew install trivy
docker run aquasec/trivy 
```

## Usage

### Local

#### scan vuln of project dependency

```
# cd to project directory
trivy fs . \
--exit-code 1 \
--cache-dir .trivycache/ \
--severity "CRITICAL,HIGH" \
--ignore-unfixed \
--scanners "vuln" \
--no-progress
```

#### scan vuln, misconfig, secret of project 

```
# cd to project directory
trivy fs . \
--exit-code 1 \
--cache-dir .trivycache/ \
--severity "CRITICAL,HIGH" \
--ignore-unfixed \
--scanners "vuln,misconfig,secret" \
--no-progress
```

#### scan container image

```
docker build -t temp-image .
trivy image temp-image \
--exit-code 1 \
--cache-dir .trivycache/ \
--severity "CRITICAL,HIGH" \
--ignore-unfixed \
--scanners "vuln" \
--no-progress
```


#### note

```
    TRIVY_SEVERITY: "CRITICAL,HIGH"         # "CRITICAL", "HIGH", "MEDIUM", "LOW", "UNKNOWN"
    TRIVY_SCANNERS: "vuln"                  # "vuln", "misconfig", "secret", "license"
```

---

### Gitlab


`template/trivy-ci.yaml`
```
.trivy-scan-vuln-fs:
  stage: test
  image: alpine:latest
  rules:
    - if: '$TRIVY_SCAN_MODE == "auto" && $CI_COMMIT_BRANCH != ""'
      when: always
    - if: '$TRIVY_SCAN_MODE == "manual"'
      when: manual
  allow_failure: false
  variables:
    TRIVY_SCAN_MODE: "auto"               # "manual" or "auto"
    TRIVY_SCAN_PATH: "."                     # Directory to scan
    TRIVY_SEVERITY: "CRITICAL,HIGH"         # "CRITICAL", "HIGH", "MEDIUM", "LOW", "UNKNOWN"
    TRIVY_SCANNERS: "vuln"                  # "vuln", "misconfig", "secret", "license"
  before_script:
    - apk add --no-cache curl
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  script:
    - |
      if [ ! -d "$TRIVY_SCAN_PATH" ]; then
        echo "Error: Path $TRIVY_SCAN_PATH does not exist or is inaccessible."
        exit 1
      fi
    - |
      trivy fs $TRIVY_SCAN_PATH \
        --exit-code 1 \
        --cache-dir .trivycache/ \
        --severity $TRIVY_SEVERITY \
        --ignore-unfixed \
        --scanners $TRIVY_SCANNERS \
        --no-progress
  # Cache directory used by Trivy to store scan results and improve performance.  # Cache directory used by Trivy to store scan results and improve performance.
  # This cache directory is shared across jobs to optimize performance and reduce redundant downloads by reusing scan results.
  cache:
    paths:
      - .trivycache/

.trivy-scan-all-fs:
  stage: test
  image: alpine:latest
  rules:
    - if: '$TRIVY_SCAN_MODE == "auto" && $CI_COMMIT_BRANCH != ""'
      when: always
    - if: '$TRIVY_SCAN_MODE == "manual"'
      when: manual
  allow_failure: false
  variables:
    TRIVY_SCAN_MODE: "manual"               # "manual" or "auto"
    TRIVY_SCAN_PATH: "."                     # Directory to scan
    TRIVY_SEVERITY: "CRITICAL,HIGH"         # "CRITICAL", "HIGH", "MEDIUM", "LOW", "UNKNOWN"
    TRIVY_SCANNERS: "vuln,misconfig,secret"                  # "vuln", "misconfig", "secret", "license"
  before_script:
    - apk add --no-cache curl
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  script:
    - |
      if [ ! -d "$TRIVY_SCAN_PATH" ]; then
        echo "Error: Path $TRIVY_SCAN_PATH does not exist or is inaccessible."
        exit 1
      fi
    - |
      trivy fs $TRIVY_SCAN_PATH \
        --exit-code 1 \
        --cache-dir .trivycache/ \
        --severity $TRIVY_SEVERITY \
        --ignore-unfixed \
        --scanners $TRIVY_SCANNERS \
        --no-progress
  # Cache directory used by Trivy to store scan results and improve performance.  # Cache directory used by Trivy to store scan results and improve performance.
  # This cache directory is shared across jobs to optimize performance and reduce redundant downloads by reusing scan results.
  cache:
    paths:
      - .trivycache/

.trivy-scan-vuln-image:
  stage: test
  image: docker:stable
  services:
    - name: docker:dind
      # Unset the DOCKER_HOST environment variable to ensure the Docker daemon runs correctly
      entrypoint: ["env", "-u", "DOCKER_HOST"]
      command: ["dockerd-entrypoint.sh"]
  rules:
    - if: '$TRIVY_SCAN_MODE == "auto" && $CI_COMMIT_BRANCH != ""'
      when: always
    - if: '$TRIVY_SCAN_MODE == "manual"'
      when: manual
  allow_failure: false
  variables:
    TRIVY_SCAN_MODE: "manual"               # "manual" or "auto"
    TEMP_IMAGE: "temp-image"  # Docker image to scan
    TRIVY_SEVERITY: "CRITICAL,HIGH"         # "CRITICAL", "HIGH", "MEDIUM", "LOW", "UNKNOWN"
    TRIVY_SCANNERS: "vuln"                  # "vuln", "misconfig", "secret", "license"
    DOCKER_BUILD_PATH: "."                # Path to Docker build context
    DOCKER_FILE_PATH: "docker/Dockerfile" # Path to Dockerfile
  script:
    # Build the Docker image locally
    - docker build --pull -f $DOCKER_FILE_PATH -t $TEMP_IMAGE $DOCKER_BUILD_PATH
    # Validate if the Docker image exists
    - |
      docker image inspect "$TEMP_IMAGE" > /dev/null 2>&1 || {
        echo "Error: Docker image $TEMP_IMAGE does not exist."
        exit 1
      }
    # Run Trivy in a container to scan the image
    - |
      docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v ${CI_PROJECT_DIR}/.trivycache:/root/.cache/ \
        aquasec/trivy:latest \
        image $TEMP_IMAGE \
        --exit-code 1 \
        --severity $TRIVY_SEVERITY \
        --ignore-unfixed \
        --scanners $TRIVY_SCANNERS \
        --no-progress
    # Delete the Docker image after scanning
    - | 
      docker rmi "$TEMP_IMAGE" || echo "Warning: Failed to delete Docker image $TEMP_IMAGE"

  cache:
    paths:
      - .trivycache/
```

`.gitlab-ci.yaml` in app project

```
trivy-scan-dependency:
  extends: .trivy-scan-vuln-fs

trivy-scan-config:
  extends: .trivy-scan-all-fs

trivy-scan-image:
  extends: .trivy-scan-vuln-image

include:
  - project: '../template/'
    file: '/trivy-ci.yaml'
    ref: main
```